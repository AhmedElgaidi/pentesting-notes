# Authentication:

It's the process of verifying an individual, entity, or website is whom it claims to be. Authentication in websites is commonly performed by submitting an identifier (username, id) and one or more private information that only a given user should know.

### General guidelines:
1) #### User Identifier:
    - Identifier (email, username, id, etc...) is case insensitive (ahmed !== Ahmed, etc...).
    - This identifier should be unique
        - Only one user has this identifier.
        - Don't allow for special characters (ahmed !== ahme.d or ahmed+d, etc...)
    - This identifier shouldn't be in public.
    - What should i use as a user identifier email, username or id?
    **It's better to create and use unique id for every user and identify him with it.**
2) #### Implement Proper Password Strength Controls:
    - Password length:
        - Length >= 8 chars (less than that considered really weak).
        - Length <= 64 chars 
            - Due to limitation in certain hashing algorithms as discussed in [Password storage sheet cheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html#maximum-password-lengths).
            - It's important to set maximum length, [to prevent long password denial of service attack](https://www.acunetix.com/vulnerabilities/web/long-password-denial-of-service/)
        - Provide him with a strength meter on the UI.
        - Provide him with the ability to check if his password is compromised before or not [Pwned passwords](https://haveibeenpwned.com/Passwords).
        - Don't force user to add special characters/ lower/ upper case chars or even numbers, let him write whatever he wants.
3) #### Implement Password Recovery Mechanism **(Forgot password)**:
    - It's good to provide the user with ways to recover (re-access) his account if he forgot his password.
    - This functionality may be source of many vulnerabilities especially [user enumeration attack](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account.html), So be careful, The process may be divided into **2 mains steps** :
        1) ###### Forget password request:
            When the user provide us with email/ username, these things should be considered, to make the step secure as much as possible:
            - Return a consistent message for both existent and non-existent accounts.
            - Ensure that responses return in a consistent amount of time to prevent an attacker enumerating which accounts exist. This could be achieved by using asynchronous calls or by making sure that the same logic is followed, instead of using a quick exit method (A the hacker can analyze response time with burp).
            - Implement protections against automated submissions such as CAPTCHA, rate-limiting or other controls.
            - Don't forget to validate and sanitize data for preventing injection with malicious payloads.
        2) ###### User resets his password:
            Once the user has proved their identity by providing the token (sent via an email) or code (sent via SMS or other mechanisms), they should reset their password to a new secure one. In order to secure this step, the measures that should be taken are:
            - The user should confirm the password they set by writing it twice.
            - Follow the same password policy he did on registration page.
            - Update and store the password in a secure way (hashed and with salt)
            - Send the user an email informing them that their password has been reset (do not send the password in the email!).
            - Log user out( End all of his active sessions) and make him login with the new credentials!

    - Methods:
        In order to provide forgot password functionality, you need a way to identify the user, either:
        (You can use them all to really ensure that he is the user he claims to be, if you don't use anyone of them, at least make them contact the support and follow some verifying identity process)
        There are general security practices for the reset password identifier (URL token, PINs, etc...):
        - Generate a cryptographically secure random number.
                - we could use JWTs, but follow the [JWT best practices](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html).
        - Long enough to protect against brute-force attacks.
        - Linked to an individual user in the database.
        - Invalidated after they have been used (One time use).
        - Store them securely in the DB (hash + salt).
        1) ###### URL tokens:
            tokens are passed in the query string of the URL, and are typically sent to the user via email. The basic overview of the process is as follows:
            1) Generate a token to the user and attach it in the URL query string.
            2) Send this token to the user via email.
            3) Don't rely ont he HOST header, while creating reset URL to avoid [HOST header attack](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/17-Testing_for_Host_Header_Injection).
            4) The URL should be either be hard-coded, or should be validated against a list of trusted domains (This is the mitigation of Host Header Injection).
            5) Ensure that the URL is using HTTPS.
            6) The user receives the email, and browses to the URL with the attached token.
            7) Ensure that the reset password page adds the [Referrer Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy) tag with the noreferrer value in order to avoid [referrer leakage](https://portswigger.net/kb/issues/00500400_cross-domain-referer-leakage).
            8) Implement appropriate protection to prevent users from brute-forcing tokens in the URL, such as rate limiting.
            9) If required, perform any additional validation steps such as requiring the user to answer security questions (or chain multiple methods to ensure more it's him!!!).
            10) Let the user create a new password and confirm it. Ensure that the same password policy used elsewhere in the application is applied.


        2) ###### PINs:
            Look at OWASP
        3) ###### Offline methods:
            It works when the user want to reset his password without requesting a URL token or a PIN from the backend **(However, authentication still needs to be conducted by the backend to ensure that the request is legitimate)**.
            Either by (Each has it's pros and cons):
            - Backup codes:
            - certificates:
            - hardware OTP tokens:
        4) ###### Security questions:
        Shouldn't be used alone in a critical scenarios as password reset as it may be easily guessable
4) #### Change password feature:
    complete from here










### Notes:
- ##### On registration. Should i use email or username as a user id?
    - It really depends on the website flow (logic).
    - One main reason to use username not email is to protect user email from being in public and get phished or spammed, now all users can see his username and only he/she can see his email, But what if the DB is compromised, should i hash/ encrypt email? i searched an found, it's not necessary, and the good question was what would happen if someone know user email!!! we have MFA/ 2FA and hashed password!! So, our user is still safe, instead, we should invest more effort in securing the DB itself!!! and also hashing/encrypting decreases the performance!!!
    - What if a user wants to have multiple accounts? They'll need another email address, right!!. So, with unique username, user can use one email for multiple accounts.